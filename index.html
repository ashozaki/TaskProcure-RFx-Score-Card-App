<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TaskProcure RFx Score Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --tp-primary: #0c3c78;
      --tp-primary-soft: #e7f0fb;
      --tp-accent: #00b894;
      --tp-bg: #f3f5fb;
      --tp-card-bg: #ffffff;
      --tp-border: #d9e2ef;
      --tp-text-main: #1f2933;
      --tp-text-muted: #64748b;
      --tp-danger: #f97373;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #eef3ff 0, #f9fafb 40%, #eef2ff 100%);
      color: var(--tp-text-main);
    }

    .app-shell {
      max-width: 1240px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    /* HEADER */

    .app-header {
      background: #ffffff;
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      padding: 14px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .app-header-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 16px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f0f4ff, #ffffff);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.25);
    }

    .app-header-logo img {
      height: 56px;           /* zoomed logo */
      width: auto;
      display: block;
    }

    .app-header-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-header-kicker {
      letter-spacing: 0.18em;
      text-transform: uppercase;
      font-size: 11px;
      color: #94a3b8;
      font-weight: 600;
    }

    .app-header-title {
      font-size: 22px;
      letter-spacing: 0.02em;
      font-weight: 700;
      color: var(--tp-primary);
    }

    .app-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .live-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      background: #0f172a;
      color: #e5f2ff;
      font-size: 12px;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.35);
    }

    .live-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: radial-gradient(circle, #4ade80 0, #16a34a 60%, #15803d 100%);
      box-shadow: 0 0 0 4px rgba(74, 222, 128, 0.25);
    }

    /* TOP CONTROL ROW */

    .controls-row {
      display: grid;
      grid-template-columns: 1.6fr 1.4fr auto;
      gap: 14px;
      margin-bottom: 12px;
    }

    .pill-card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 14px 16px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .pill-title {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #94a3b8;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .pill-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--tp-border);
      padding: 8px 14px;
      font-size: 13px;
      color: var(--tp-text-main);
      background: #f9fafb;
    }

    .pill-badges {
      display: flex;
      gap: 14px;
      margin-top: 2px;
    }

    .pill-badge-label {
      font-size: 11px;
      color: var(--tp-text-muted);
    }

    .pill-badge-value {
      font-size: 13px;
      font-weight: 700;
    }

    .pill-badge-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .controls-row-buttons {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--tp-border);
      background: #ffffff;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--tp-text-main);
    }

    .btn-primary {
      background: var(--tp-primary);
      border-color: var(--tp-primary);
      color: #ffffff;
    }

    .btn-icon {
      font-size: 14px;
    }

    /* METRICS BELT */

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 10px;
    }

    .metric-card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 10px 14px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.28);
    }

    .metric-label {
      font-size: 11px;
      letter-spacing: 0.17em;
      text-transform: uppercase;
      color: #94a3b8;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .metric-main {
      font-size: 22px;
      font-weight: 700;
      color: #16a34a;
    }

    .metric-main-small {
      font-size: 18px;
    }

    .metric-sub {
      font-size: 12px;
      color: var(--tp-text-muted);
      margin-top: 2px;
    }

    .metric-rank-list {
      font-size: 12px;
      color: var(--tp-text-main);
      margin: 0;
      padding-left: 16px;
    }

    .metric-rank-list li {
      margin-bottom: 2px;
    }

    .metric-progress {
      margin-top: 6px;
    }

    .progress-track {
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      width: 0%;
      transition: width 200ms ease-out;
    }

    /* SCORECARD INSTRUCTIONS + SNAPSHOT */

    .instructions-snapshot-row {
      display: grid;
      grid-template-columns: 1.4fr 1.1fr;
      gap: 12px;
      margin-bottom: 14px;
    }

    .card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 14px 16px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .card-title {
      font-size: 11px;
      letter-spacing: 0.17em;
      text-transform: uppercase;
      color: #94a3b8;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .card ul {
      margin: 6px 0 4px;
      padding-left: 16px;
    }

    .card ul li {
      font-size: 13px;
      color: var(--tp-text-main);
      margin-bottom: 2px;
      list-style: none; /* remove bullets */
    }

    .snapshot-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 14px;
      margin-top: 4px;
      font-size: 12px;
      color: var(--tp-text-main);
    }

    .snapshot-label {
      color: var(--tp-text-muted);
    }

    .snapshot-value {
      font-weight: 600;
      text-align: right;
    }

    .snapshot-value-green {
      color: #16a34a;
    }

    /* SCORECARD TABLE */

    .scorecard-shell {
      background: #ffffff;
      border-radius: 22px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 14px 16px 16px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      padding: 10px 8px;
      text-align: left;
      color: #0f172a;
      font-size: 12px;
      border-bottom: 1px solid var(--tp-border);
    }

    thead th.sticky {
      position: sticky;
      left: 0;
      background: #fffffe;
      z-index: 2;
    }

    tbody tr:nth-child(odd) {
      background: #f9fafb;
    }

    tbody tr:nth-child(even) {
      background: #ffffff;
    }

    tbody td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .col-section {
      min-width: 260px;
      font-weight: 500;
    }

    .col-weight {
      width: 90px;
      text-align: center;
    }

    .col-remove {
      width: 70px;
      text-align: center;
    }

    input[type="number"],
    input[type="text"],
    select {
      border-radius: 999px;
      border: 1px solid var(--tp-border);
      padding: 4px 10px;
      font-size: 13px;
      font-family: inherit;
      background: #ffffff;
      width: 100%;
    }

    input[type="number"] {
      text-align: center;
    }

    .score-select {
      text-align: center;
    }

    .btn-icon-circle {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.45);
      background: rgba(254, 242, 242, 0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #b91c1c;
      font-size: 14px;
    }

    .row-total-weight {
      font-weight: 600;
    }

    .weight-ok {
      color: #16a34a;
    }

    .weight-bad {
      color: #b91c1c;
    }

    .totals-row-label {
      font-weight: 600;
    }

    .totals-row {
      background: #e5efff;
      font-size: 13px;
    }

    .totals-row td {
      border-bottom: none;
      padding-top: 10px;
      padding-bottom: 6px;
    }

    .totals-row-secondary {
      background: #dbe7ff;
    }

    .totals-label-with-max {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .max-value {
      font-weight: 700;
      font-size: 13px;
      color: #16a34a;
    }

    /* DECISION NOTES */

    .notes-card {
      margin-top: 12px;
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 12px 14px 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .notes-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .notes-title {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #94a3b8;
      font-weight: 600;
    }

    .notes-hint {
      font-size: 11px;
      color: var(--tp-text-muted);
    }

    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--tp-border);
      padding: 8px 10px;
      font-size: 13px;
      min-height: 70px;
      resize: vertical;
      font-family: inherit;
      background: #f9fafb;
    }

    /* ADD-CRITERION STRIP */

    .add-criterion-row {
      display: grid;
      grid-template-columns: 1.6fr 1.3fr 0.5fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      margin-top: 6px;
    }

    .add-criterion-row select,
    .add-criterion-row input {
      font-size: 12px;
      padding: 5px 10px;
    }

    .add-criterion-row .btn {
      padding-inline: 18px;
      font-size: 12px;
    }

    .vendor-header {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }

    .vendor-name-input {
      max-width: 110px;
      text-align: center;
      padding-inline: 8px;
    }

    .vendor-remove-x {
      color: #ef4444;
      cursor: pointer;
      font-size: 14px;
    }

    @media (max-width: 980px) {
      .controls-row {
        grid-template-columns: 1fr;
      }
      .metrics-row {
        grid-template-columns: 1fr 1fr;
      }
      .instructions-snapshot-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- HEADER -->
  <header class="app-header">
    <div class="app-header-left">
      <div class="app-header-logo">
        <img src="Taskprocure Logo.png" alt="TaskProcure logo" />
      </div>
      <div class="app-header-title-block">
        <div class="app-header-kicker">RFX Evaluation Dashboard</div>
        <div class="app-header-title">Score Card &amp; Vendor Ranking</div>
      </div>
    </div>
    <div class="app-header-right">
      <div class="live-pill">
        <span class="live-dot"></span>
        <span>Live scoring Â· Excel export ready</span>
      </div>
    </div>
  </header>

  <!-- PROJECT NAME & BUTTONS -->
  <div class="controls-row">
    <div class="pill-card">
      <div class="pill-title">Project / RFx Name</div>
      <input id="projectName" class="pill-input" placeholder="e.g. Digital Identity &amp; PKI RFx 2026" />
    </div>

    <div class="pill-card">
      <div class="pill-title">Vendors &amp; Sections</div>
      <div class="pill-badges">
        <div class="pill-badge-pill">
          <div class="pill-badge-label">Vendors in scope</div>
          <div class="pill-badge-value" id="vendorsInScope">0</div>
        </div>
        <div class="pill-badge-pill">
          <div class="pill-badge-label">RFx evaluation sections</div>
          <div class="pill-badge-value" id="rfxSections">0</div>
        </div>
      </div>
    </div>

    <div class="controls-row-buttons">
      <button id="addCriterionBtn" class="btn">
        <span class="btn-icon">ï¼‹</span> Add Criterion
      </button>
      <button id="addVendorBtn" class="btn">
        <span class="btn-icon">ï¼‹</span> Add Vendor
      </button>
      <button id="exportBtn" class="btn btn-primary">
        <span class="btn-icon">â¬‡</span> Export Scorecard
      </button>
    </div>
  </div>

  <!-- METRIC CARDS -->
  <div class="metrics-row">
    <div class="metric-card">
      <div class="metric-label">Leading Vendor (Live)</div>
      <div id="leadingVendorName" class="metric-main metric-main-small">â€”</div>
      <div id="leadingVendorScores" class="metric-sub">Score â€” Â· Weighted â€”</div>
      <div id="leadingVendorWeights" class="metric-sub">Weight total: â€” Â· Normalised to â€”</div>
    </div>

    <div class="metric-card">
      <div class="metric-label">Scorecard Completion</div>
      <div class="metric-main metric-main-small" id="completionPercent">0%</div>
      <div class="metric-progress">
        <div class="progress-track">
          <div id="completionBar" class="progress-bar"></div>
        </div>
      </div>
      <div class="metric-sub" id="completionDetail">0 of 0 scores captured</div>
    </div>

    <div class="metric-card">
      <div class="metric-label">Score Distribution</div>
      <div class="snapshot-grid">
        <span class="snapshot-label">Total possible score</span>
        <span id="metricPossibleScore" class="snapshot-value snapshot-value-green">0</span>
        <span class="snapshot-label">Total possible weighted</span>
        <span id="metricPossibleWeighted" class="snapshot-value snapshot-value-green">0.00</span>
        <span class="snapshot-label">Best vs 2nd (weighted)</span>
        <span id="metricSpread" class="snapshot-value">â€”</span>
        <span class="snapshot-label">Vendors scored</span>
        <span id="metricVendorsScored" class="snapshot-value">0</span>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-label">Vendor Ranking Snapshot</div>
      <ol id="metricVendorRanking" class="metric-rank-list"></ol>
    </div>
  </div>

  <!-- INSTRUCTIONS + SNAPSHOT (SHORT) -->
  <div class="instructions-snapshot-row">
    <div class="card">
      <div class="card-title">Score Card Instructions</div>
      <ul>
        <li>0 â€“ If solution does not meet needs</li>
        <li>1 â€“ If solution only partially meets needs</li>
        <li>2 â€“ If solution fully meets needs</li>
        <li>3 â€“ If solution exceeds needs (without adding unnecessary cost)</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title">Scoring Snapshot (Live)</div>
      <div class="snapshot-grid">
        <span class="snapshot-label">Total sections</span>
        <span id="snapshotSections" class="snapshot-value">0</span>

        <span class="snapshot-label">Total vendors</span>
        <span id="snapshotVendors" class="snapshot-value">0</span>

        <span class="snapshot-label">Total possible score</span>
        <span id="snapshotPossibleScore" class="snapshot-value snapshot-value-green">0</span>

        <span class="snapshot-label">Total possible weighted</span>
        <span id="snapshotPossibleWeighted" class="snapshot-value snapshot-value-green">0.00</span>

        <span class="snapshot-label">Best weighted score</span>
        <span id="snapshotBestWeighted" class="snapshot-value">0.00</span>

        <span class="snapshot-label">2nd best weighted</span>
        <span id="snapshotSecondWeighted" class="snapshot-value">0.00</span>
      </div>
    </div>
  </div>

  <!-- ADD CRITERION STRIP -->
  <div class="add-criterion-row">
    <select id="librarySelect">
      <option value="">-- Select RFx Evaluation Section --</option>
    </select>
    <input id="customSectionName" type="text" placeholder="Custom evaluation section name" />
    <input id="newWeightInput" type="number" min="1" max="100" value="10" />
    <button id="addCriterionConfirmBtn" class="btn btn-primary">Add</button>
  </div>

  <!-- SCORECARD TABLE -->
  <div class="scorecard-shell">
    <table id="scoreTable">
      <thead>
      <tr>
        <th class="col-section sticky">RFx Evaluation Section</th>
        <th class="col-weight">Weight %</th>
        <th id="vendorHeader-A">Vendor A</th>
        <th id="vendorHeader-B">Vendor B</th>
        <th id="vendorHeader-C" style="display:none;"></th>
        <th id="vendorHeader-D" style="display:none;"></th>
        <th class="col-remove">Remove</th>
      </tr>
      </thead>
      <tbody id="scoreTbody"></tbody>
      <tfoot>
      <tr class="row-total-weight">
        <td class="totals-row-label">Total Weight %</td>
        <td id="totalWeightCell" colspan="5" class="weight-ok">100%</td>
        <td></td>
      </tr>
      <tr class="totals-row">
        <td>
          <span class="totals-label-with-max">
            <span>Total Vendor Score</span>
            <span id="maxRawSpan" class="max-value"></span>
          </span>
        </td>
        <td></td>
        <td id="totRawA">0.0</td>
        <td id="totRawB">0.0</td>
        <td id="totRawC">0.0</td>
        <td id="totRawD">0.0</td>
        <td></td>
      </tr>
      <tr class="totals-row totals-row-secondary">
        <td>
          <span class="totals-label-with-max">
            <span>Total Weighted Score</span>
            <span id="maxWeightedSpan" class="max-value"></span>
          </span>
        </td>
        <td></td>
        <td id="totWeightedA">0.00</td>
        <td id="totWeightedB">0.00</td>
        <td id="totWeightedC">0.00</td>
        <td id="totWeightedD">0.00</td>
        <td></td>
      </tr>
      </tfoot>
    </table>
  </div>

  <!-- DECISION NOTES -->
  <div class="notes-card">
    <div class="notes-label-row">
      <div class="notes-title">Decision Rationale / Notes</div>
      <div class="notes-hint">Capture key trade-offs, risks, and final recommendation.</div>
    </div>
    <textarea placeholder="Example: Vendor A recommended based on strongest weighted score in critical categories (Security, Cloud Capabilities), lower TCO, and better roadmap alignment."></textarea>
  </div>

</div>

<script>
  /***************
   * DATA
   ***************/
  const evaluationSections = [
    "Adaptability to Future Technologies",
    "Alignment with Organizational Goals",
    "API Availability and Functionality",
    "Automation and AI Features",
    "Carbon Footprint Reductions Plans",
    "Cloud Capabilities",
    "Commercial Evaluation (Pricing Model, TCO, Payment terms etc.)",
    "Compatibility with Existing Systems",
    "Compliance & Data Security (GDPR, HIPAA, CCPA etc.)",
    "Compliance & Elgibility",
    "Contract Terms & Conditions (e.g., MSA, LRA, SOW, Order Form, Pricing Schedules, SLAs, DPAs, etc.)",
    "Core Functionalities",
    "Corporate Social Responsibility Initiatives",
    "Custom Workflow Capabilities",
    "Customization for Industry Specific Needs",
    "Customization Options",
    "Data Accuracy and Integrity",
    "Data Analytics & Insights",
    "Data Governance",
    "Data Privacy and Protection",
    "Data Residency and Sovereignty",
    "Data Storage and Backup",
    "Deployment Speed",
    "Downtime and Recovery Plans",
    "Encryption Standards",
    "Energy Efficiency",
    "Environmental Impact",
    "Fit For Purpose",
    "Flexibility & Adaptability (Vendor's ability to accommodate change)",
    "Functional Requirements",
    "Future Proofing Capabilities",
    "Governance & Change Management",
    "Helpdesk and Ticketing Systems",
    "Hypercare / Post-Implementation Support",
    "Implementation Timeline",
    "Maintenance and Upgrades",
    "Mobility and Remote Access",
    "Monitoring & Reporting",
    "Multi-tenancy and Isolation",
    "Onboarding & Implementation",
    "Post-Go-Live Support",
    "Pricing",
    "Pricing Proposal",
    "Project Management Approach & Methodology",
    "Real-Time Monitoring and Alerts",
    "Redundancy and Failover Capabilities",
    "Remote Monitoring and Management",
    "Reporting and Analytics",
    "Resources",
    "Responsible Disposal of Hardware",
    "RFx Questionnaire & Documentation Requested",
    "Risk Mitigation Plans",
    "Role-Based Access Control",
    "Scalability",
    "Security Certifications & Compliance (ISO, SOC, etc.)",
    "Security Operations & Monitoring",
    "Service Availability & Uptime SLAs",
    "Service Delivery Model",
    "Service Level Agreements (SLAs)",
    "Solution Design & Architecture",
    "Solution Roadmap & Innovation",
    "Support Model (Hours, Channels, Languages)",
    "System Integration",
    "System Performance and Speed",
    "Technical & Functional Requirements",
    "Technical Excellence and Innovation (Code quality, automation, CI/CD, DevOps, TDD)",
    "Technical Proposal",
    "Technical Requirements",
    "Technical Solution",
    "Technical Support Availability",
    "Third-Party Integrations",
    "Total Cost of Ownership (TCO)",
    "Training, Documentation & Knowledge Transfer",
    "User Interface and Experience (UI/UX)",
    "Vendor Compliance with ESG Standards",
    "Vendor Responsiveness",
    "Vendorâ€™s Product Roadmap",
    "Warranty Terms"
  ];

  const vendors = [
    { id: "A", name: "Vendor A", active: true },
    { id: "B", name: "Vendor B", active: true },
    { id: "C", name: "Vendor C", active: false },
    { id: "D", name: "Vendor D", active: false }
  ];

  let criteria = [
    { name: "Alignment with Organizational Goals", weight: 20, scores: {A: 3, B: 2} },
    { name: "API Availability and Functionality",    weight: 20, scores: {A: 3, B: 2} },
    { name: "Automation and AI Features",           weight: 20, scores: {A: 3, B: 1} },
    { name: "Cloud Capabilities",                   weight: 40, scores: {A: 3, B: 3} }
  ];

  /***************
   * HELPERS
   ***************/
  function getActiveVendors() {
    return vendors.filter(v => v.active);
  }

  function sum(arr) {
    return arr.reduce((a, b) => a + b, 0);
  }

  function calculateTotals() {
    const activeVendors = getActiveVendors();
    const numCriteria = criteria.length;
    const totalPossibleScore = numCriteria * 3;
    const totalWeight = sum(criteria.map(c => Number(c.weight) || 0));

    const vendorTotals = {};
    activeVendors.forEach(v => vendorTotals[v.id] = { raw: 0, weighted: 0 });

    criteria.forEach(c => {
      const w = Number(c.weight) || 0;
      activeVendors.forEach(v => {
        const s = (c.scores && typeof c.scores[v.id] === "number") ? c.scores[v.id] : 0;
        vendorTotals[v.id].raw += s;
        vendorTotals[v.id].weighted += (w / 100) * s;
      });
    });

    const weightedMax = (totalWeight / 100) * 3;

    // Completion
    const totalCells = numCriteria * activeVendors.length;
    let filledCells = 0;
    criteria.forEach(c => {
      activeVendors.forEach(v => {
        if (c.scores && typeof c.scores[v.id] === "number") filledCells++;
      });
    });
    const completion = totalCells === 0 ? 0 : (filledCells / totalCells) * 100;

    // Ranking
    const ranking = activeVendors.map(v => ({
      ...v,
      raw: vendorTotals[v.id].raw,
      weighted: vendorTotals[v.id].weighted
    })).sort((a, b) => b.weighted - a.weighted || b.raw - a.raw);

    const best = ranking[0]?.weighted ?? 0;
    const second = ranking[1]?.weighted ?? 0;

    return {
      totalPossibleScore,
      totalWeight,
      vendorTotals,
      weightedMax,
      completion,
      filledCells,
      totalCells,
      ranking,
      bestWeighted: best,
      secondWeighted: second
    };
  }

  /***************
   * RENDER
   ***************/
  function renderLibraryDropdown() {
    const select = document.getElementById("librarySelect");
    evaluationSections.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  }

  function renderTable() {
    const tbody = document.getElementById("scoreTbody");
    tbody.innerHTML = "";

    const activeVendors = getActiveVendors();

    // Headers with editable names + remove
    ["A", "B", "C", "D"].forEach(id => {
      const headerCell = document.getElementById("vendorHeader-" + id);
      const vendor = vendors.find(v => v.id === id);
      if (!vendor) return;

      if (vendor.active) {
        headerCell.style.display = "";
        headerCell.innerHTML = "";
        const wrapper = document.createElement("div");
        wrapper.className = "vendor-header";

        const input = document.createElement("input");
        input.type = "text";
        input.value = vendor.name;
        input.className = "vendor-name-input";
        input.addEventListener("input", () => {
          vendor.name = input.value || ("Vendor " + vendor.id);
          renderAll();
        });

        const removeX = document.createElement("span");
        removeX.className = "vendor-remove-x";
        removeX.textContent = "Ã—";
        removeX.title = "Remove vendor";
        removeX.addEventListener("click", () => {
          vendor.active = false;
          renderAll();
        });

        wrapper.appendChild(input);
        wrapper.appendChild(removeX);
        headerCell.appendChild(wrapper);
      } else {
        headerCell.style.display = "none";
        headerCell.innerHTML = "";
      }
    });

    // Rows
    criteria.forEach((c, rowIndex) => {
      const tr = document.createElement("tr");

      const tdSection = document.createElement("td");
      tdSection.className = "col-section";
      tdSection.textContent = c.name;
      tr.appendChild(tdSection);

      const tdWeight = document.createElement("td");
      tdWeight.className = "col-weight";
      const weightInput = document.createElement("input");
      weightInput.type = "number";
      weightInput.min = "0";
      weightInput.max = "100";
      weightInput.value = c.weight;
      weightInput.addEventListener("input", () => {
        c.weight = Number(weightInput.value) || 0;
        renderAll();
      });
      tdWeight.appendChild(weightInput);
      tr.appendChild(tdWeight);

      activeVendors.forEach(v => {
        const td = document.createElement("td");
        const select = document.createElement("select");
        select.className = "score-select";
        ["-", "0", "1", "2", "3"].forEach(val => {
          const opt = document.createElement("option");
          opt.value = val === "-" ? "" : val;
          opt.textContent = val;
          select.appendChild(opt);
        });
        const current = c.scores && typeof c.scores[v.id] === "number"
          ? String(c.scores[v.id]) : "";
        select.value = current;
        select.addEventListener("change", () => {
          if (!c.scores) c.scores = {};
          c.scores[v.id] = select.value === "" ? undefined : Number(select.value);
          renderAll();
        });
        td.appendChild(select);
        tr.appendChild(td);
      });

      // Fill blanks for inactive vendor columns (so tfoot layout is ok)
      const missingCells = 4 - activeVendors.length;
      for (let i = 0; i < missingCells; i++) {
        const td = document.createElement("td");
        td.style.display = "none";
        tr.appendChild(td);
      }

      const tdRemove = document.createElement("td");
      tdRemove.className = "col-remove";
      const btn = document.createElement("button");
      btn.className = "btn-icon-circle";
      btn.textContent = "ðŸ—‘";
      btn.title = "Remove criterion";
      btn.addEventListener("click", () => {
        criteria.splice(rowIndex, 1);
        renderAll();
      });
      tdRemove.appendChild(btn);
      tr.appendChild(tdRemove);

      tbody.appendChild(tr);
    });

    // Totals
    const {
      totalPossibleScore,
      totalWeight,
      vendorTotals,
      weightedMax,
      completion,
      filledCells,
      totalCells,
      ranking,
      bestWeighted,
      secondWeighted
    } = calculateTotals();

    const weightCell = document.getElementById("totalWeightCell");
    weightCell.textContent = (totalWeight || 0).toFixed(0) + "%";
    weightCell.className = "weight-" + (totalWeight === 100 ? "ok" : "bad");

    document.getElementById("maxRawSpan").textContent = "(" + totalPossibleScore + ")";
    document.getElementById("maxWeightedSpan").textContent = "(" + (weightedMax || 0).toFixed(2) + ")";

    // Per-vendor totals cells
    ["A", "B", "C", "D"].forEach(id => {
      const vendor = vendors.find(v => v.id === id);
      const rawCell = document.getElementById("totRaw" + id);
      const wCell = document.getElementById("totWeighted" + id);
      if (vendor && vendor.active) {
        rawCell.style.display = "";
        wCell.style.display = "";
        rawCell.textContent = vendorTotals[id].raw.toFixed(1);
        wCell.textContent = vendorTotals[id].weighted.toFixed(2);
      } else {
        rawCell.style.display = "none";
        wCell.style.display = "none";
      }
    });

    // Project stats labels
    document.getElementById("vendorsInScope").textContent = getActiveVendors().length;
    document.getElementById("rfxSections").textContent = criteria.length;

    // Completion pill
    const completionPercent = totalCells === 0 ? 0 : completion;
    document.getElementById("completionPercent").textContent = completionPercent.toFixed(0) + "%";
    document.getElementById("completionDetail").textContent =
      `${filledCells} of ${totalCells} scores captured`;
    document.getElementById("completionBar").style.width = completionPercent.toFixed(0) + "%";

    // Leading vendor card
    if (ranking.length > 0) {
      const lead = ranking[0];
      document.getElementById("leadingVendorName").textContent =
        `${lead.name} (${lead.weighted.toFixed(2)})`;
      document.getElementById("leadingVendorScores").textContent =
        `Score ${lead.raw.toFixed(1)} Â· Weighted ${lead.weighted.toFixed(2)}`;
      document.getElementById("leadingVendorWeights").textContent =
        `Weight total: ${totalWeight.toFixed(0)}% Â· Perfectly normalised to 100%.`;
    } else {
      document.getElementById("leadingVendorName").textContent = "â€”";
      document.getElementById("leadingVendorScores").textContent = "Score â€” Â· Weighted â€”";
      document.getElementById("leadingVendorWeights").textContent = "Weight total: â€”";
    }

    // Vendor ranking metric card
    const metricList = document.getElementById("metricVendorRanking");
    metricList.innerHTML = "";
    ranking.forEach((v, index) => {
      const li = document.createElement("li");
      li.textContent = `${index + 1}) ${v.name} â€” Score ${v.raw.toFixed(1)}, Weighted ${v.weighted.toFixed(2)}`;
      metricList.appendChild(li);
    });

    // Scoring snapshot metrics
    document.getElementById("metricPossibleScore").textContent = totalPossibleScore;
    document.getElementById("metricPossibleWeighted").textContent = weightedMax.toFixed(2);
    document.getElementById("metricSpread").textContent =
      ranking.length > 1 ? (bestWeighted - secondWeighted).toFixed(2) : "â€”";
    document.getElementById("metricVendorsScored").textContent = ranking.length;

    document.getElementById("snapshotSections").textContent = criteria.length;
    document.getElementById("snapshotVendors").textContent = getActiveVendors().length;
    document.getElementById("snapshotPossibleScore").textContent = totalPossibleScore;
    document.getElementById("snapshotPossibleWeighted").textContent = weightedMax.toFixed(2);
    document.getElementById("snapshotBestWeighted").textContent = bestWeighted.toFixed(2);
    document.getElementById("snapshotSecondWeighted").textContent = secondWeighted.toFixed(2);
  }

  function renderAll() {
    renderTable();
  }

  /***************
   * EVENTS
   ***************/
  function setupEvents() {
    document.getElementById("addCriterionBtn").addEventListener("click", () => {
      document.getElementById("librarySelect").focus();
    });

    document.getElementById("addCriterionConfirmBtn").addEventListener("click", () => {
      const libVal = document.getElementById("librarySelect").value;
      const customName = document.getElementById("customSectionName").value.trim();
      const weight = Number(document.getElementById("newWeightInput").value) || 10;
      const name = customName || libVal;
      if (!name) return;
      criteria.push({ name, weight, scores: {} });
      document.getElementById("customSectionName").value = "";
      document.getElementById("librarySelect").value = "";
      renderAll();
    });

    document.getElementById("addVendorBtn").addEventListener("click", () => {
      const inactive = vendors.find(v => !v.active);
      if (!inactive) return;
      inactive.active = true;
      renderAll();
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      alert("Static HTML version: export to Excel is not wired to a backend yet.\n\nYou can still copy/paste this table directly into Excel.");
    });
  }

  /***************
   * INIT
   ***************/
  function init() {
    renderLibraryDropdown();
    setupEvents();
    renderAll();
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
